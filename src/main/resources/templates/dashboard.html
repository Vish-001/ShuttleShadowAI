<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShadowShuttleAI | Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
          --neon-blue: #00f3ff;
          --neon-pink: #ff00ff;
          --neon-purple: #bd00ff;
          --dark-bg: #0a0a18;
          --darker-bg: #050510;
          --card-bg: rgba(15, 15, 35, 0.7);
        }

        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
          font-family: 'Rajdhani', 'Orbitron', sans-serif;
        }

        body {
          background: var(--darker-bg);
          color: white;
          min-height: 100vh;
          overflow-x: hidden;
          position: relative;
        }

        #particles-js {
          position: fixed;
          width: 100%;
          height: 100%;
          z-index: -1;
        }

        header {
          padding: 1.5rem 2rem;
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: rgba(10, 10, 24, 0.8);
          border-bottom: 1px solid var(--neon-blue);
          box-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
          position: relative;
          z-index: 10;
        }

        .logo {
          display: flex;
          align-items: center;
          gap: 12px;
        }

        .logo-icon {
          width: 40px;
          height: 40px;
          background: linear-gradient(135deg, var(--neon-blue), var(--neon-purple));
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 0 15px var(--neon-blue);
          animation: pulse 2s infinite alternate;
        }

        .logo-text {
          font-size: 1.8rem;
          font-weight: 700;
          text-transform: uppercase;
          letter-spacing: 2px;
          background: linear-gradient(to right, var(--neon-blue), var(--neon-pink));
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
        }

        .user-info {
          display: flex;
          align-items: center;
          gap: 15px;
        }

        .user-avatar {
          width: 45px;
          height: 45px;
          border-radius: 50%;
          background: linear-gradient(45deg, var(--neon-purple), var(--neon-pink));
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          font-size: 1.2rem;
          box-shadow: 0 0 10px var(--neon-pink);
        }

        .logout-btn {
          background: transparent;
          border: 1px solid var(--neon-pink);
          color: white;
          padding: 8px 20px;
          border-radius: 30px;
          cursor: pointer;
          font-weight: 600;
          letter-spacing: 1px;
          transition: all 0.3s ease;
          text-transform: uppercase;
          font-size: 0.8rem;
        }

        .logout-btn:hover {
          background: rgba(255, 0, 255, 0.2);
          box-shadow: 0 0 15px var(--neon-pink);
          transform: translateY(-2px);
        }

        .dashboard {
          max-width: 1400px;
          margin: 2rem auto;
          padding: 0 2rem;
        }

        .welcome-banner {
          text-align: center;
          margin-bottom: 3rem;
          animation: fadeIn 1s ease-out;
        }

        .welcome-banner h1 {
          font-size: 2.5rem;
          margin-bottom: 0.5rem;
          text-transform: uppercase;
          letter-spacing: 3px;
          background: linear-gradient(to right, var(--neon-blue), var(--neon-pink));
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
        }

        .dashboard-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 2rem;
        }

        .card {
          background: var(--card-bg);
          border-radius: 15px;
          padding: 1.5rem;
          backdrop-filter: blur(10px);
          border: 1px solid rgba(100, 100, 255, 0.2);
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
          transition: all 0.3s ease;
          position: relative;
          overflow: hidden;
        }

        .card-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1.5rem;
          padding-bottom: 0.8rem;
          border-bottom: 1px solid rgba(100, 100, 255, 0.3);
        }

        .card-title {
          font-size: 1.5rem;
          font-weight: 600;
          display: flex;
          align-items: center;
          gap: 10px;
        }

        .session-list {
          display: flex;
          flex-direction: column;
          gap: 1rem;
        }

        .session-item {
          background: rgba(20, 20, 50, 0.5);
          padding: 1rem;
          border-radius: 10px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          transition: all 0.3s ease;
          border-left: 3px solid var(--neon-blue);
        }

        .session-item:hover {
          background: rgba(30, 30, 70, 0.7);
          transform: translateX(5px);
        }

        .session-info {
          display: flex;
          flex-direction: column;
          gap: 5px;
        }

        .session-mode {
          font-weight: bold;
          text-transform: uppercase;
          font-size: 0.9rem;
          letter-spacing: 1px;
        }

        .session-mode.easy { color: #4caf50; }
        .session-mode.standard { color: #ffc107; }
        .session-mode.hard { color: #f44336; }
        .session-mode.improve { color: var(--neon-pink); }

        .session-stats {
          display: flex;
          gap: 15px;
          font-size: 0.9rem;
          color: #a0a0c0;
        }

        .session-actions {
          display: flex;
          gap: 10px;
        }

        .btn {
          padding: 6px 15px;
          border-radius: 20px;
          border: none;
          cursor: pointer;
          font-weight: 600;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          gap: 5px;
        }

        .btn-delete {
          background: rgba(244, 67, 54, 0.2);
          color: #f44336;
          border: 1px solid #f44336;
        }

        .btn-view {
          background: rgba(33, 150, 243, 0.2);
          color: #2196f3;
          border: 1px solid #2196f3;
        }

        .start-session-btn {
          background: linear-gradient(45deg, var(--neon-blue), var(--neon-purple));
          color: white;
          padding: 12px 30px;
          font-size: 1.1rem;
          border: none;
          border-radius: 30px;
          cursor: pointer;
          font-weight: 600;
          letter-spacing: 1px;
          transition: all 0.3s ease;
          text-transform: uppercase;
          box-shadow: 0 0 15px rgba(0, 243, 255, 0.5);
          margin-top: 2rem;
          display: block;
          width: fit-content;
          margin-left: auto;
          margin-right: auto;
        }

        .start-session-btn:hover {
          transform: translateY(-3px);
          box-shadow: 0 0 25px rgba(0, 243, 255, 0.8);
        }

        @keyframes pulse {
          0% { box-shadow: 0 0 15px var(--neon-blue); }
          100% { box-shadow: 0 0 25px var(--neon-purple); }
        }

        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 1100px) {
          .dashboard-grid {
            grid-template-columns: 1fr;
          }
        }
    </style>
</head>
<body>
<div id="particles-js"></div>

<header>
    <div class="logo">
        <div class="logo-icon">
            <i class="fas fa-table-tennis"></i>
        </div>
        <div class="logo-text">ShuttleShadowAI</div>
    </div>

    <div class="user-info">
        <div class="user-avatar" th:text="${#strings.substring(username, 0, 1)}">U</div>
        <button class="logout-btn" onclick="location.href='/logout'">Logout <i class="fas fa-sign-out-alt"></i></button>
    </div>
</header>

<div class="dashboard">
    <div class="welcome-banner">
        <h1>Welcome Back, <span th:text="${username}">User</span>!</h1>
        <p>Track your progress and improve your reaction time with AI-powered training</p>
    </div>

    <div class="dashboard-grid">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-history"></i> Session History</h2>
            </div>

            <div class="session-list">
                <div class="session-item" th:each="sess : ${sessions}">
                    <div class="session-info">
                        <div class="session-mode" th:classappend="${'session-mode.' + sess.mode.toString().toLowerCase()}"
                             th:text="${sess.mode == 'MEDIUM' ? 'Standard' : 'Improve'}">MODE</div>
                        <div class="session-date" th:text="${#temporals.format(sess.startTime, 'dd-MMM-yyyy HH:mm')}">Date</div>
                        <div class="session-stats">
                <span th:if="${sess.zonePerformances != null and not sess.zonePerformances.isEmpty()}">
                  Avg: <span th:text="${#numbers.formatDecimal(#aggregates.avg(sess.zonePerformances.![averageReactionTime]), 0, 0)}">0</span>ms
                </span>
                            <span th:if="${sess.zonePerformances == null or sess.zonePerformances.isEmpty()}">
                  Avg: —
                </span>
                            <span th:if="${sess.zonePerformances != null and not sess.zonePerformances.isEmpty()}">
                  Hits: <span th:text="${#aggregates.sum(sess.zonePerformances.![hits])}">0</span>
                </span>
                            <span th:if="${sess.zonePerformances == null or sess.zonePerformances.isEmpty()}">
                  Hits: —
                </span>
                            <span>
                  Weak: <span th:text="${sess.weakestZone != null ? sess.weakestZone : '—'}">—</span>
                </span>
                        </div>
                    </div>
                    <div class="session-actions">
                        <a th:href="@{/session/{id}/details(id=${sess.id})}" class="btn btn-view">
                            <i class="fas fa-chart-bar"></i> View
                        </a>
                        <form th:action="@{/session/{id}/delete(id=${sess.id})}" method="post" style="display:inline">
                            <button type="submit" class="btn btn-delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </div>

                <div class="session-item" th:if="${#lists.isEmpty(sessions)}">
                    <div class="session-info">
                        No sessions yet
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-chart-line"></i> Performance Analytics</h2>
            </div>

            <div th:if="${not #lists.isEmpty(sessions)}">
                <canvas id="performanceChart" width="400" height="200"></canvas>
                <script th:inline="javascript">
                    /*<![CDATA[*/
                    document.addEventListener('DOMContentLoaded', function() {
                      const ctx = document.getElementById('performanceChart').getContext('2d');
                      const sessions = /*[[${sessions}]]*/ [];
                      console.log("Dashboard sessions:", sessions);

                      if (!sessions || sessions.length === 0) {
                        console.warn("No session data available for chart.");
                        return;
                      }

                      const labels = sessions.map(s =>
                        new Date(s.startTime).toLocaleDateString() + ' ' + (s.mode === 'MEDIUM' ? 'Standard' : 'Improve')
                      );
                      const data = sessions.map(s =>
                        s.zonePerformances && s.zonePerformances.length > 0 ?
                        Math.round(s.zonePerformances.reduce((sum, z) => sum + z.averageReactionTime, 0) / s.zonePerformances.length) : 0
                      );

                      console.log("Chart labels:", labels);
                      console.log("Chart data:", data);

                      try {
                        new Chart(ctx, {
                          type: 'line',
                          data: {
                            labels: labels,
                            datasets: [{
                              label: 'Average Reaction Time (ms)',
                              data: data,
                              borderColor: '#00f3ff',
                              backgroundColor: 'rgba(0, 243, 255, 0.1)',
                              tension: 0.3,
                              fill: true
                            }]
                          },
                          options: {
                            responsive: true,
                            scales: {
                              y: {
                                beginAtZero: false,
                                title: { display: true, text: 'Reaction Time (ms)', color: '#a0a0c0' },
                                ticks: { color: '#a0a0c0' },
                                grid: { color: 'rgba(100, 100, 255, 0.2)' }
                              },
                              x: {
                                title: { display: true, text: 'Sessions', color: '#a0a0c0' },
                                ticks: { color: '#a0a0c0' },
                                grid: { color: 'rgba(100, 100, 255, 0.2)' }
                              }
                            },
                            plugins: {
                              legend: { labels: { color: '#a0a0c0' } }
                            }
                          }
                        });
                      } catch (error) {
                        console.error("Chart initialization failed:", error);
                      }
                    });
                    /*]]>*/
                </script>
            </div>

            <div th:if="${#lists.isEmpty(sessions)}">
                <p style="text-align: center; color: #a0a0c0; margin-top: 2rem;">
                    Complete your first session to see analytics
                </p>
            </div>
        </div>
    </div>

    <a th:href="@{/session/start}" class="start-session-btn">
        <i class="fas fa-plus"></i> Start New Session
    </a>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<script>
    particlesJS('particles-js', {
      particles: {
        number: { value: 80, density: { enable: true, value_area: 800 } },
        color: { value: "#00f3ff" },
        shape: { type: "circle" },
        opacity: { value: 0.5, random: true },
        size: { value: 3, random: true },
        line_linked: {
          enable: true,
          distance: 150,
          color: "#bd00ff",
          opacity: 0.2,
          width: 1
        },
        move: {
          enable: true,
          speed: 2,
          direction: "none",
          random: true,
          straight: false,
          out_mode: "out",
          bounce: false
        }
      },
      interactivity: {
        detect_on: "canvas",
        events: {
          onhover: { enable: true, mode: "grab" },
          onclick: { enable: true, mode: "push" },
          resize: true
        },
        modes: {
          grab: { distance: 140, line_linked: { opacity: 1 } },
          push: { particles_nb: 4 }
        }
      },
      retina_detect: true
    });
</script>
</body>
</html>
